@startuml OEM_Allocation_View
!theme plain
skinparam backgroundColor #FFFFFF
skinparam defaultFontSize 10

' Color definitions
!define PHYSICAL_COLOR #FFE0B2
!define NETWORK_COLOR #B3E5FC
!define SERVER_COLOR #F8BBD0
!define DB_COLOR #FFF9C4

skinparam node {
    BackgroundColor PHYSICAL_COLOR
    BorderColor #E65100
    FontSize 11
    FontStyle bold
}

skinparam cloud {
    BackgroundColor #E8F5E9
    BorderColor #2E7D32
    FontSize 11
}

skinparam component {
    BackgroundColor #E1BEE7
    BorderColor #6A1B9A
    FontSize 10
}

skinparam rectangle {
    BackgroundColor SERVER_COLOR
    BorderColor #C2185B
    FontSize 10
}

skinparam database {
    BackgroundColor DB_COLOR
    BorderColor #F57F17
    FontSize 11
}

skinparam storage {
    BackgroundColor #FFCCBC
    BorderColor #D84315
    FontSize 10
}

title Allocation View - Physical Deployment Architecture\nOEM Online Exam Monitoring System\n(Hardware, Software, Network Infrastructure)

' ============ CLIENT TIER ============
node "üíª CLIENT MACHINE\n<<User Device>>" as client_machine #E3F2FD {
    component "üåê Web Browser\n(Chrome/Firefox/Edge)\nPort 4000 (Dev)\nPort 80/443 (Prod)" as web_browser
    component "üìπ Webcam\n(Face Capture)" as webcam
    component "üì± Camera/Scanner\n(Card Capture)" as camera
}

' ============ NETWORK LAYER ============
cloud "‚òÅÔ∏è INTERNET\n<<Public Network>>" as internet #E8F5E9

rectangle "üîê FIREWALL\n<<Security Layer>>" as firewall #FFCDD2 {
    component "Port 80 (HTTP)" as port_80
    component "Port 443 (HTTPS)" as port_443
    component "Port 5000 (API)" as port_5000
}

' ============ APPLICATION SERVER ============
node "‚öôÔ∏è APPLICATION SERVER\n<<Windows 10/11 or Linux Ubuntu 20.04+>>\nRAM: 8GB+ | CPU: 4 Cores+ | Disk: 50GB+" as app_server #FFECB3 {
    
    rectangle "üü¢ NODE.JS RUNTIME\n<<v18.x or v20.x>>" as nodejs_runtime {
        component "Express.js Backend\nPort 5000\n(app.js)" as express_app
        component "Socket.IO Server\nWebSocket\nPort 5000" as socket_server
        component "API Router\n(Routes Layer)" as api_router
        component "Middleware Layer\n(Auth, CORS, etc.)" as middleware_layer
    }
    
    rectangle "üêç PYTHON RUNTIME\n<<Python 3.9+>>" as python_runtime {
        component "Face Verification\nOpenCV + Uniface\nface_verification_uniface.py" as python_face
        component "Card OCR\nTesseract + pytesseract\nstudent_card_filter.py" as python_card
        component "Essay Grading AI\nNLP Semantic Analysis\nessay_grading.py" as python_essay
        component "Unified Verify Script\nverify_images.py" as python_unified
    }
    
    rectangle "üì¶ STATIC ASSETS\n<<Build Output>>" as static_assets {
        storage "React Build\n(dist/build folder)\nServed by Express" as react_build
    }
    
    rectangle "üìÅ FILE STORAGE\n<<Local Disk>>" as file_storage {
        storage "Uploaded Images\n(Face, Card)\n/uploads folder" as uploads_folder
        storage "Exam Files\n(Excel Import)\n/exam_files" as exam_files
        storage "Logs\n/logs folder" as logs_folder
    }
}

' ============ DATABASE SERVER ============
node "üóÑÔ∏è DATABASE SERVER\n<<MySQL 8.0.x>>\nRAM: 4GB+ | Disk: 20GB+" as db_server #FFF9C4 {
    database "oem_mini Database\nPort 3306" as mysql_database {
        component "users table" as tbl_users
        component "exams table" as tbl_exams
        component "submissions table" as tbl_submissions
        component "student_answers table" as tbl_answers
        component "ai_logs table" as tbl_ai_logs
        component "exam_questions table" as tbl_questions
        component "exam_options table" as tbl_options
        component "results table" as tbl_results
        component "user_verified_rooms table" as tbl_rooms
    }
}

' ============ EXTERNAL SERVICES ============
cloud "üìß GMAIL SMTP SERVER\n<<smtp.gmail.com>>\nPort 587 (TLS)" as gmail_smtp #C8E6C9

cloud "üîê GOOGLE OAUTH 2.0\n<<accounts.google.com>>\nHTTPS Port 443" as google_oauth #C8E6C9

' ============ DEPLOYMENT CONNECTIONS ============

' Client to Internet
client_machine -down-> internet : "HTTPS Request\n(Port 443)"
web_browser -up-> webcam : "getUserMedia() API"
web_browser -up-> camera : "Capture Image"

' Internet to Firewall
internet -down-> firewall : "Public IP\nHTTPS/HTTP"

' Firewall to App Server
port_443 -down-> express_app : "SSL/TLS Encrypted"
port_5000 -down-> express_app : "Development Mode"
port_80 -down-> express_app : "HTTP Redirect to HTTPS"

' App Server Internal Connections
express_app -down-> api_router : "Route Requests"
api_router -down-> middleware_layer : "Authentication\nAuthorization"
middleware_layer -right-> socket_server : "WebSocket Upgrade"
socket_server ..> web_browser : "Bi-directional\nReal-time Events"

' Express to Python
express_app -down-> python_unified : "spawn() subprocess\nJSON stdin/stdout"
python_unified -down-> python_face : "Face Verification"
python_unified -down-> python_card : "Card OCR"
python_unified -down-> python_essay : "Essay Grading"

' Express to File Storage
express_app -right-> uploads_folder : "Save/Load Images"
express_app -right-> exam_files : "Import Excel"
express_app -right-> logs_folder : "Write Logs"

' Express to Static Assets
express_app -up-> react_build : "Serve SPA\napp.use(express.static)"

' App Server to Database
express_app -down-> mysql_database : "TCP/IP Connection\nSequelize ORM + MySQL2\nPort 3306"

' App Server to External Services
express_app -down-> gmail_smtp : "SMTP TLS\nSend OTP Email\nPort 587"
express_app -down-> google_oauth : "OAuth 2.0 Flow\nHTTPS Port 443"

' Python to Database (for AI logs)
python_essay -down-> tbl_ai_logs : "Log NLP Results\n(via Node.js)"
python_face -down-> tbl_ai_logs : "Log Face Compare\n(via Node.js)"

' ============ COMMUNICATION PROTOCOLS ============
note bottom of internet
  **Communication Protocols:**
  - HTTPS/TLS 1.3 (Encrypted)
  - WebSocket (Real-time)
  - TCP/IP (Database)
  - SMTP TLS (Email)
end note

note bottom of app_server
  **Application Server Environment:**
  - OS: Windows 10/11 or Ubuntu 20.04+
  - Node.js: v18.x or v20.x
  - Python: 3.9+ (with pip)
  - Dependencies: npm packages, Python packages
  - Process Manager: PM2 (Production)
end note

note bottom of db_server
  **Database Server:**
  - MySQL 8.0.x
  - Character Set: utf8mb4
  - Collation: utf8mb4_unicode_ci
  - InnoDB Engine
  - Backup: Daily automated backup
end note

note right of python_runtime
  **Python Dependencies:**
  - OpenCV (cv2)
  - Tesseract OCR
  - Uniface (RetinaFace, ArcFace)
  - NumPy, pandas
  - pytesseract
  - scikit-learn (NLP)
  - NLTK or spaCy (optional)
end note

note right of file_storage
  **File Storage:**
  - Images stored as BLOB in DB
  - OR file path in uploads folder
  - Excel files processed then deleted
  - Logs rotated daily
end note

' ============ DEPLOYMENT SCENARIOS ============
rectangle "üöÄ DEPLOYMENT SCENARIOS" as deployment_box #E0F2F1 {
    rectangle "Development Environment" as dev_env #B2DFDB {
        component "Frontend: npm run dev (Vite)\nPort 4000" as dev_frontend
        component "Backend: npm run dev (nodemon)\nPort 5000" as dev_backend
        component "DB: localhost:3306" as dev_db
    }
    
    rectangle "Production Environment" as prod_env #C8E6C9 {
        component "Frontend: Built and served by Express\nPort 80/443" as prod_frontend
        component "Backend: PM2 cluster mode\nPort 5000 (internal)" as prod_backend
        component "DB: Remote MySQL Server\nPort 3306" as prod_db
        component "Reverse Proxy: Nginx\nPort 80/443" as nginx_proxy
    }
}

' ============ LEGEND ============
legend bottom left
|= Symbol |= Description |
| üíª | **Client Device** |
| ‚òÅÔ∏è | **Cloud/Network** |
| ‚öôÔ∏è | **Server Machine** |
| üóÑÔ∏è | **Database Server** |
| üîê | **Security Layer** |
| üì¶ | **Software Package** |
| üìÅ | **File/Folder** |
| ‚îÅ‚îÅ‚îÅ> | **Network Connection** |
| ‚ãØ‚ãØ> | **WebSocket** |
| ‚îÄ‚îÄ> | **Process Call** |
endlegend

' ============ INFRASTRUCTURE NOTES ============
note top of client_machine
  **Client Requirements:**
  - Modern browser (Chrome 90+)
  - Webcam for face capture
  - Internet connection (2 Mbps+)
  - JavaScript enabled
end note

@enduml
